<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>添加用户组</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../../lib/layui-v2.13.2/css/layui.css" media="all">
    <link rel="stylesheet" href="../../../css/public.css" media="all">
    <link rel="stylesheet" href="../../../lib/font-awesome-4.7.0/css/font-awesome.min.css" media="all">
    <style>
        /* 使用与 add_user.html 相同的布局样式以保持一致 */
        .layuimini-form {
            max-width: 820px;
            margin: 28px auto;
            background: #fff;
            padding: 22px 26px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
        }
        .layuimini-form .layui-form-label { width: 110px; padding-right: 12px; }
        .layuimini-form .layui-input-block { margin-left: 140px; }
        .layuimini-form .layui-form-item .layui-input-block .layui-btn{ margin-left:0 }
        .add-group-header{ display:flex; align-items:center; gap:12px; padding:6px 0 18px 0; border-bottom:1px solid #f0f0f0; margin-bottom:12px }
        .add-group-header .header-icon{ color:#f56c6c; font-size:20px }
        .add-group-header .header-text{ font-size:18px; font-weight:600; color:#333 }
    </style>
</head>
<body>
<form class="layui-form layuimini-form" lay-filter="addGroupForm">
    <div class="layui-form-item">
        <label class="layui-form-label required">用户组编码</label>
        <div class="layui-input-block">
            <input id="groupCode" type="text" name="groupcode" lay-verify="required" lay-reqtext="编码不能为空" placeholder="英文字母/数字/下划线" value="" class="layui-input">
            <tip>唯一编码，用于系统识别（如 sysadmin）。</tip>
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label required">用户组名</label>
        <div class="layui-input-block">
            <input id="groupName" type="text" name="groupname" lay-verify="required" lay-reqtext="名称不能为空" placeholder="显示名称" value="" class="layui-input">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">排序</label>
        <div class="layui-input-block">
            <input type="number" name="sort" placeholder="数字，值越小越靠前（可选）" value="0" class="layui-input">
        </div>
    </div>

    <div class="layui-form-item layui-form-text">
        <label class="layui-form-label">描述</label>
        <div class="layui-input-block">
            <textarea name="description" placeholder="可选，简单说明用户组用途" class="layui-textarea"></textarea>
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">状态</label>
        <div class="layui-input-block">
            <input type="checkbox" name="status" lay-skin="switch" lay-text="活跃|禁用" checked>
        </div>
    </div>

    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn layui-btn-normal" lay-submit lay-filter="saveGroupBtn" style="margin-right:12px">确认保存</button>
            <button type="button" class="layui-btn layui-btn-primary" id="cancelBtn">取消</button>
        </div>
    </div>
</form>

<script src="../../../lib/layui-v2.13.2/layui.js" charset="utf-8"></script>
<script src="../../../js/lay-config.js" charset="utf-8"></script>
<script>
    layui.use(['form'], function () {
        var form = layui.form,
            layer = layui.layer,
            $ = layui.$;

        form.verify({
            // 简单验证：非空
            required: function(value){ if(!value || !String(value).trim()) return '不能为空'; }
        });

        // 尝试把带图标的“添加用户组”标题注入到父 layer 的标题栏（如在 iframe/modal 中打开）
        try{
            var idx = parent.layer.getFrameIndex(window.name);
            var $layerDom = parent.$('#layui-layer' + idx);
            if($layerDom && $layerDom.length){
                $layerDom.find('.parent-add-user-title').remove();
                var titleHtml = '<div class="parent-add-user-title" style="position:absolute;right:86px;top:50%;transform:translateY(-50%);display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border-radius:6px;border:2px solid #f6c74a;background:#fff;z-index:9999">'
                    + '<i class="fa fa-users" style="color:#f56c6c;font-size:14px;margin-right:6px"></i>'
                    + '<span style="font-weight:600;color:#333">添加用户组</span>'
                    + '</div>';
                $layerDom.find('.layui-layer-title').append(titleHtml);
            }
        }catch(e){ /* ignore if parent not accessible */ }

        // 取消按钮
        $('#cancelBtn').on('click', function(){
            try{ var idx = parent.layer.getFrameIndex(window.name); parent.layer.close(idx); }catch(e){ window.close && window.close(); }
        });

        form.on('submit(saveGroupBtn)', function(data){
            var f = data.field;
            var status = (f.status === 'on' || f.status === 'true' || f.status === '1') ? 1 : 0;
            // 按后端结构体的 json 标签组织请求体（snake_case）
            var payload = {
                group_code: f.groupcode,
                group_name: f.groupname,
                sort: parseInt(f.sort) || 0,
                description: f.description || undefined,
                status: status
            };

            layer.load(2);
            $.ajax({
                // 后端路由为 POST /group/add，若前端使用 api 前缀 window.apiBase（例如 '/api'），会被自动拼接
                url: (window.apiBase || '') + '/api/group/add',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                headers: { Authorization: 'Bearer ' + (localStorage.getItem('access_token') || '') },
                success: function(res){
                    layer.closeAll('loading');
                    var ok = false;
                    if(!res) ok = false;
                    else if(res.code === 0 || res.success === true || res.status === 'ok') ok = true;
                    else if(typeof res === 'boolean') ok = res;

                    if(ok){
                        layer.msg('添加成功', {icon:1}, function(){
                            try{ var idx = parent.layer.getFrameIndex(window.name); parent.layer.close(idx); }catch(e){}
                            try{ parent.layui.table.reload('currentTableId'); }catch(e){}
                        });
                    } else {
                        layer.msg((res && res.msg) || '添加失败', {icon:2});
                    }
                },
                error: function(xhr){
                    layer.closeAll('loading');
                    layer.msg('请求错误：' + xhr.status, {icon:2});
                }
            });

            return false;
        });
    });
</script>
</body>
</html>