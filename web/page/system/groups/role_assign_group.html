<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>分配角色</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../../lib/layui-v2.13.2/css/layui.css" media="all">
    <link rel="stylesheet" href="../../../css/public.css" media="all">
    <style>
        .layuimini-form { max-width: 980px; margin: 18px auto; background: #fff; padding: 18px; border-radius: 4px; }
        .perm-tree-wrap{ padding:12px; border:1px solid #eee; border-radius:6px; max-height:520px; overflow:auto }
    </style>
</head>
<body>

<form class="layui-form layuimini-form" lay-filter="permForm">
    <input type="hidden" id="groupId">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
        <div id="groupInfo" style="color:#666"></div>
    </div>

    <div class="perm-tree-wrap">
        <div id="roleList"></div>
    </div>

    <div style="margin-top:16px;text-align:right">
        <button class="layui-btn layui-btn-normal" lay-submit lay-filter="savePerms">确认保存</button>
        <button type="button" class="layui-btn layui-btn-primary" id="cancelBtn">取消</button>
    </div>
</form>

<script src="../../../lib/layui-v2.13.2/layui.js" charset="utf-8"></script>
<script src="../../../js/lay-config.js" charset="utf-8"></script>
<script>
    layui.use(['form','layer','jquery'], function(){
        var form = layui.form, layer = layui.layer, $ = layui.$;

        function getQueryParam(name){
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
            var r = window.location.search.substr(1).match(reg);
            if(r != null) return decodeURIComponent(r[2]);
            return null;
        }

        var groupId = getQueryParam('id');
        if(!groupId){ layer.msg('用户组ID参数缺失',{icon:2}); }
        $('#groupId').val(groupId);

        function loadData(){
            layer.load(2);
            var rolesUrl = (window.apiBase || '') + '/api/role/list';
            var groupRoleUrl = (window.apiBase || '') + '/api/group/role/' + groupId;

            var reqs = [
                $.ajax({url: rolesUrl, method:'GET', headers: { Authorization: 'Bearer ' + (localStorage.getItem('access_token') || '') }}),
                $.ajax({url: groupRoleUrl, method:'GET', headers: { Authorization: 'Bearer ' + (localStorage.getItem('access_token') || '') }})
            ];

            $.when.apply($, reqs).done(function(rolesRes, groupRes){
                layer.closeAll('loading');
                var rolesData = (rolesRes && rolesRes[0]) ? rolesRes[0] : null;
                var groupData = (groupRes && groupRes[0]) ? groupRes[0] : null;

                var roles = [];
                if(rolesData && rolesData.code === 0 && Array.isArray(rolesData.data)) roles = rolesData.data;
                else if(Array.isArray(rolesData)) roles = rolesData;

                var assigned = [];
                if(groupData && groupData.code === 0 && Array.isArray(groupData.data)) assigned = groupData.data;
                else if(Array.isArray(groupData)) assigned = groupData;

                // render checkbox list
                var $wrap = $('#roleList');
                $wrap.empty();
                if(roles.length === 0){ $wrap.append('<div>无可分配角色</div>'); form.render(); return; }
                for(var i=0;i<roles.length;i++){
                    var r = roles[i];
                    var id = r.ID || r.id || r.role_id || r.key || r.value;
                    var name = r.RoleName || r.role_name || r.name || r.Role || r.role || ('角色-' + id);
                    var checked = assigned.indexOf(id) !== -1 ? 'checked' : '';
                    var html = '<input type="checkbox" name="role_checkbox" value="'+ id +'" title="'+ (name || '') +'" '+ checked +' lay-skin="primary">';
                    $wrap.append(html);
                }
                form.render();

                if(groupData && groupData.code === 0 && groupData.extra && groupData.extra.name){
                    $('#groupInfo').text('当前组：' + groupData.extra.name);
                }

            }).fail(function(){
                layer.closeAll('loading');
                layer.msg('加载角色数据失败，请检查接口', {icon:2});
            });
        }

        loadData();

        form.on('submit(savePerms)', function(){
            var vals = [];
            $('input[name="role_checkbox"]:checked').each(function(){ vals.push($(this).val()); });

            layer.load(2);
            $.ajax({
                url: (window.apiBase || '') + '/api/group/role/' + groupId,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({ roles: vals }),
                headers: { Authorization: 'Bearer ' + (localStorage.getItem('access_token') || '') },
                success: function(res){
                    layer.closeAll('loading');
                    var ok = false;
                    if(!res) ok = false;
                    else if(res.code === 0 || res.success === true || res.status === 'ok') ok = true;
                    else if(typeof res === 'boolean') ok = res;
                    if(ok){
                        layer.msg('角色关联更新成功', {icon:1}, function(){
                            try{ var idx = parent.layer.getFrameIndex(window.name); parent.layer.close(idx);}catch(e){}
                            try{ parent.layui.table.reload('currentTableId'); }catch(e){}
                        });
                    } else {
                        layer.msg((res && res.msg) || '更新失败', {icon:2});
                    }
                },
                error: function(xhr){ layer.closeAll('loading'); layer.msg('请求错误：' + xhr.status, {icon:2}); }
            });

            return false;
        });

        $('#cancelBtn').on('click', function(){ try{ var idx = parent.layer.getFrameIndex(window.name); parent.layer.close(idx);}catch(e){ window.close && window.close(); } });

    });
</script>
</body>
</html>
