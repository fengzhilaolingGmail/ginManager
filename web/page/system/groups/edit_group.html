<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>编辑用户组</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../../lib/layui-v2.13.2/css/layui.css" media="all">
    <link rel="stylesheet" href="../../../css/public.css" media="all">
    <link rel="stylesheet" href="../../../lib/font-awesome-4.7.0/css/font-awesome.min.css" media="all">
    <style>
        .layuimini-form { max-width: 820px; margin: 28px auto; background: #fff; padding: 22px 26px; border-radius: 4px; box-shadow: 0 2px 6px rgba(0,0,0,0.04); }
        .layuimini-form .layui-form-label { width: 110px; padding-right: 12px; }
        .layuimini-form .layui-input-block { margin-left: 140px; }
        .edit-group-header{ display:flex; align-items:center; gap:12px; padding:6px 0 18px 0; border-bottom:1px solid #f0f0f0; margin-bottom:12px }
        .edit-group-header .header-icon{ color:#409eff; font-size:20px }
        .edit-group-header .header-text{ font-size:18px; font-weight:600; color:#333 }
        .readonly { background-color: #f5f7fa; color: #909399; cursor: not-allowed; }
    </style>
</head>
<body>
<form class="layui-form layuimini-form" lay-filter="editGroupForm">
    <input type="hidden" name="id" id="groupId">

    <div class="layui-form-item" style="display:flex; gap:12px; align-items:center; flex-wrap:nowrap;">
        <div class="layui-inline" style="flex:0 0 calc(50% - 6px); display:flex; align-items:center;">
            <label class="layui-form-label" style="width:110px; padding-right:12px; margin:0;">ID</label>
            <div class="layui-input-inline" style="width:120px;">
                <input type="text" id="groupIdDisplay" disabled class="layui-input layui-disabled" placeholder="组ID" style="width:100%;">
            </div>
        </div>
    <div class="layui-inline" style="flex:0 0 calc(50% - 6px); display:flex; align-items:center;">
            <label class="layui-form-label required" style="width:110px; padding-right:12px; margin:0;">编码</label>
            <div class="layui-input-inline" style="flex:1; min-width:160px;">
                <input type="text" id="groupCodeField" name="group_code" disabled class="layui-input readonly" placeholder="组编码" style="width:100%;">
            </div>
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label required">组名称</label>
        <div class="layui-input-block">
            <input type="text" name="group_name" lay-verify="required" lay-reqtext="组名称不能为空" placeholder="组名称" value="" class="layui-input">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">排序</label>
        <div class="layui-input-block">
            <input type="number" name="sort" placeholder="数字，值越小越靠前" value="0" class="layui-input">
        </div>
    </div>

    <div class="layui-form-item layui-form-text">
        <label class="layui-form-label">描述</label>
        <div class="layui-input-block">
            <textarea name="description" placeholder="可选，简单说明用户组用途" class="layui-textarea"></textarea>
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">状态</label>
        <div class="layui-input-block">
            <input type="checkbox" name="status" lay-skin="switch" lay-text="活跃|禁用" checked>
        </div>
    </div>

    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn layui-btn-normal" lay-submit lay-filter="saveGroupBtn" style="margin-right:12px">确认保存</button>
            <button type="button" class="layui-btn layui-btn-primary" id="cancelBtn">取消</button>
        </div>
    </div>
</form>

<script src="../../../lib/layui-v2.13.2/layui.js" charset="utf-8"></script>
<script src="../../../js/lay-config.js" charset="utf-8"></script>
<script>
    layui.use(['form'], function () {
        var form = layui.form, layer = layui.layer, $ = layui.$;

        function getQueryParam(name){
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
            var r = window.location.search.substr(1).match(reg);
            if(r != null) return decodeURIComponent(r[2]);
            return null;
        }

        function loadGroupData(){
            var id = getQueryParam('id');
            if(!id){ layer.msg('用户组ID参数缺失',{icon:2}); return; }

            try{
                var parentData = parent.layui.table.cache.currentTableId;
                var group = null;
                if(parentData && parentData.length){
                    for(var i=0;i<parentData.length;i++){
                        if(parentData[i].ID == id){ group = parentData[i]; break; }
                    }
                }
                if(group){
                    fillForm(group);
                } else {
                    loadGroupDataFromAPI(id);
                }
            }catch(e){ loadGroupDataFromAPI(id); }
        }

        function loadGroupDataFromAPI(id){
            layer.load(2);
            $.ajax({
                url: (window.apiBase || '') + '/api/group/' + id,
                method: 'GET',
                headers: { Authorization: 'Bearer ' + (localStorage.getItem('access_token') || '') },
                success: function(res){
                    layer.closeAll('loading');
                    if(res && res.code === 0 && res.data){
                        fillForm(res.data);
                    } else {
                        layer.msg('加载用户组数据失败',{icon:2});
                    }
                },
                error: function(xhr){ layer.closeAll('loading'); if(xhr.status===404) layer.msg('获取用户组详情接口不存在', {icon:2}); else layer.msg('请求错误：' + xhr.status, {icon:2}); }
            });
        }

        function fillForm(g){
            $('#groupId').val(g.ID || g.id || '');
            $('#groupIdDisplay').val(g.ID || g.id || '');
            $('#groupCodeField').val(g.GroupCode || g.group_code || '');
            $('input[name="group_name"]').val(g.GroupName || g.group_name || '');
            $('input[name="sort"]').val(g.Sort || g.sort || 0);
            $('textarea[name="description"]').val(g.Description || g.description || '');
            if((g.Status === 0 || g.Status === '0')){
                $('input[name="status"]').removeAttr('checked');
            } else {
                $('input[name="status"]').attr('checked','checked');
            }
            form.render();
        }

        loadGroupData();

        // 注入父 layer 标题
        try{
            var idx = parent.layer.getFrameIndex(window.name);
            var $layerDom = parent.$('#layui-layer' + idx);
            if($layerDom && $layerDom.length){
                $layerDom.find('.parent-edit-group-title').remove();
                var titleHtml = '<div class="parent-edit-group-title" style="position:absolute;right:86px;top:50%;transform:translateY(-50%);display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border-radius:6px;border:2px solid #409eff;background:#fff;z-index:9999">'
                    + '<i class="fa fa-edit" style="color:#409eff;font-size:14px;margin-right:6px"></i>'
                    + '<span style="font-weight:600;color:#333">编辑用户组</span>'
                    + '</div>';
                $layerDom.find('.layui-layer-title').append(titleHtml);
            }
        }catch(e){}

        $('#cancelBtn').on('click', function(){ try{ var idx = parent.layer.getFrameIndex(window.name); parent.layer.close(idx);}catch(e){ window.close && window.close(); } });

        form.on('submit(saveGroupBtn)', function(data){
            var f = data.field;
            var id = $('#groupId').val();
            if(!id){ layer.msg('用户组ID缺失',{icon:2}); return false; }
            var status = (f.status === 'on' || f.status === 'true' || f.status === '1') ? 1 : 0;
            var payload = {
                group_code: $('#groupCodeField').val() || f.group_code || undefined,
                group_name: f.group_name,
                sort: parseInt(f.sort) || 0,
                description: f.description || undefined,
                status: status
            };
            // ensure group_code is present because backend requires it
            if(!payload.group_code){ layer.msg('组编码缺失，无法提交',{icon:2}); return false; }
            layer.load(2);
            $.ajax({
                url: (window.apiBase || '') + '/api/group/edit/' + id,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                headers: { Authorization: 'Bearer ' + (localStorage.getItem('access_token') || '') },
                success: function(res){
                    layer.closeAll('loading');
                    var ok = false;
                    if(!res) ok = false;
                    else if(res.code === 0 || res.success === true || res.status === 'ok') ok = true;
                    else if(typeof res === 'boolean') ok = res;
                    if(ok){
                        layer.msg('更新成功', {icon:1}, function(){
                            try{ var idx = parent.layer.getFrameIndex(window.name); parent.layer.close(idx);}catch(e){}
                            try{ parent.layui.table.reload('currentTableId'); }catch(e){}
                        });
                    } else {
                        layer.msg((res && res.msg) || '更新失败', {icon:2});
                    }
                },
                error: function(xhr){ layer.closeAll('loading'); layer.msg('请求错误：' + xhr.status, {icon:2}); }
            });
            return false;
        });
    });
</script>
</body>
</html>